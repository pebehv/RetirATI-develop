{% extends 'base.html' %}
{% load static %}

{% block title %}Publicación - FunATI{% endblock %}

{% block page_title %}Publicación{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/styles.css' %}">
<link rel="stylesheet" href="{% static 'css/muro.css' %}">
<link rel="stylesheet" href="{% static 'css/follows.css' %}">
{% endblock %}

{% block content %}
<!-- Publicación principal -->
<div class="post">
    <div class="post-header">
        <a href="{% url 'funATIAPP:profile_detail' publication.profile.id %}" class="profile-link" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 8px;">
            {% if publication.profile.avatar %}
                <img src="{{ publication.profile.avatar.url }}" alt="{{ publication.profile.user.username }}" class="post-avatar" />
            {% else %}
                <img src="{% static 'assets/user-placeholder.png' %}" alt="{{ publication.profile.user.username }}" class="post-avatar" />
            {% endif %}
            <span class="post-username">{{ publication.profile.user.get_full_name|default:publication.profile.user.username }}</span>
            <span class="post-handle">@{{ publication.profile.user.username }}</span>
        </a>
        <span class="post-time">{{ publication.created_at|timesince }} atrás</span>
    </div>
    <div class="post-content">{{ publication.content }}</div>
    {% if publication.media %}
    <div class="post-media-placeholder">
        <div class="media-preview">
            <img src="{{ publication.media.url }}" alt="Imagen publicación" class="publication-img" />
        </div>
    </div>
    {% endif %}
    <div class="post-actions">
        <button class="post-action">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M9.53449 0.681511L6.42349 0.674011H6.42199C3.14149 0.674011 0.571991 3.24426 0.571991 6.52551C0.571991 9.59901 2.96149 11.93 6.17074 12.053V14.924C6.17074 15.005 6.20374 15.1385 6.26074 15.2263C6.36724 15.395 6.54874 15.4865 6.73474 15.4865C6.83824 15.4865 6.94249 15.458 7.03624 15.398C7.23424 15.272 11.891 12.293 13.1022 11.2685C14.5287 10.061 15.3822 8.29101 15.3845 6.53451V6.52176C15.38 3.24651 12.812 0.681511 9.53449 0.680761V0.681511ZM12.3747 10.4105C11.5242 11.1305 8.72824 12.9643 7.29574 13.8928V11.5025C7.29574 11.192 7.04449 10.94 6.73324 10.94H6.43624C3.69124 10.94 1.69774 9.08301 1.69774 6.52551C1.69774 3.87501 3.77374 1.79901 6.42274 1.79901L9.53299 1.80651H9.53449C12.1835 1.80651 14.2595 3.88101 14.261 6.52851C14.2587 7.96101 13.5545 9.41151 12.3755 10.4105H12.3747Z" fill="#5B7083"/>
            </svg>
            <span>{{ publication.comments.count }}</span>
          </button>
    </div>
</div>
<!-- Sección de comentarios -->
<div class="comments-section container" style="margin-top: 32px;">
    <h3 style="margin-bottom: 16px;">Comentarios</h3>
    {% if user.is_authenticated %}
    <form method="post" class="funar comment-form" style="margin-bottom: 24px;">
        {% csrf_token %}
        <div class="funar-flex">
            <div class="funar-avatar-column">
                {% if user.profile.avatar %}
                    <img src="{{ user.profile.avatar.url }}" alt="{{ user.username }}" class="post-avatar" />
                {% else %}
                    <img src="{% static 'assets/user-placeholder.png' %}" alt="{{ user.username }}" class="post-avatar" />
                {% endif %}
            </div>
            <div class="funar-content-column">
                <div class="funar-input-container">
                    <span class="span-funar comment-contenteditable" id="comment-content" contenteditable="true">Escribe un comentario...</span>
                    <input type="hidden" name="content" id="hidden-comment-content" />
                    <input type="hidden" name="parent" id="comment-parent-id" value="">
                </div>
            </div>
        </div>
        <div class="buton-flex" style="position: relative; min-height: 50px;">
            <div style="margin-left: auto;">
                <button type="submit" class="button-funar" id="funar-btn">Comentar</button>
            </div>
        </div>
    </form>
    {% endif %}
    {% for comment in comments %}
    {% if not comment.parent %}
    <div class="post" style="margin-bottom: 16px;" id="comment-{{ comment.id }}">
        <div class="post-header">
            <a href="{% url 'funATIAPP:profile_detail' comment.user.profile.id %}" class="profile-link" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 8px;">
                {% if comment.user.profile.avatar %}
                    <img src="{{ comment.user.profile.avatar.url }}" alt="{{ comment.user.username }}" class="post-avatar" />
                {% else %}
                    <img src="{% static 'assets/user-placeholder.png' %}" alt="{{ comment.user.username }}" class="post-avatar" />
                {% endif %}
                <span class="post-username">{{ comment.user.username }}</span>
            </a>
            <span class="post-time">{{ comment.created_at|timesince }} atrás</span>
        </div>
        <div class="post-content">{{ comment.content }}</div>
        <div style="display: flex; justify-content: flex-end; align-items: center; margin-top: 8px;">
            <button class="reply-btn button-funar" onclick="showReplyForm('{{ comment.id }}')">Responder</button>
        </div>
        <div class="reply-form-container" id="reply-form-{{ comment.id }}" style="display:none;">
            <form method="post" class="funar reply-form" style="margin-bottom: 16px;">
                {% csrf_token %}
                <div class="funar-flex">
                    <div class="funar-avatar-column">
                        {% if user.profile.avatar %}
                            <img src="{{ user.profile.avatar.url }}" alt="{{ user.username }}" class="post-avatar" />
                        {% else %}
                            <img src="{% static 'assets/user-placeholder.png' %}" alt="{{ user.username }}" class="post-avatar" />
                        {% endif %}
                    </div>
                    <div class="funar-content-column">
                        <div class="funar-input-container">
                            <span class="span-funar reply-contenteditable" contenteditable="true">Escribe una respuesta...</span>
                            <input type="hidden" name="content" class="hidden-reply-content" />
                            <input type="hidden" name="parent" value="{{ comment.id }}">
                        </div>
                    </div>
                </div>
                <div class="buton-flex" style="position: relative; min-height: 50px;">
                    <div style="margin-left: auto;">
                        <button type="submit" class="button-funar" id="funar-btn-reply-{{ comment.id }}">Responder</button>
                    </div>
                </div>
            </form>
        </div>
        {% include "replies_recursive.html" with replies=comment.replies.all parent_margin=32 %}
    </div>
    {% endif %}
    {% empty %}
        <p>No hay comentarios aún.</p>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'assets/publication.js' %}"></script>
{% endblock %}
