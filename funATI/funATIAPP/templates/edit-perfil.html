{% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editar Perfil</title>
    
    <!-- Google Fonts - Lato -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
    <link rel="stylesheet" href="{% static 'css/edit.css' %}" />
  </head>
  <body {% if user_settings %}data-theme-mode="{{ user_settings.theme_mode }}" data-color-theme="{{ user_settings.color_theme }}"{% endif %}{% if user_settings and user_settings.theme_mode == 'oscuro' %} class="dark-theme"{% endif %}>
    <!-- Barra lateral -->
    <div id="menu-main"></div>

    <!-- Contenido principal -->
    <div class="main-content">
      <!-- Barra superior con título "Editar Perfil" -->
      <div class="top-bar">
        <h1>Editar Perfil</h1>
      </div>

      <!-- Contenido de edición de perfil -->
      <div class="edit-profile-container">
        <form method="post" enctype="multipart/form-data" id="profile-form">
          {% csrf_token %}
          
          <div class="profile-edit-header">
            <div class="profile-edit-avatar">
              {% if profile.avatar %}
                <img src="{{ profile.avatar.url }}" alt="Avatar" class="avatar-img" id="avatar-preview" />
              {% else %}
                <img src="{% static 'assets/user-placeholder.png' %}" alt="Avatar" class="avatar-img" id="avatar-preview" />
              {% endif %}
              <button type="button" class="change-avatar-btn" onclick="document.getElementById('id_avatar').click();" title="Cambiar foto de perfil">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18" fill="none">
                  <path d="M9 0C4.05 0 0 4.05 0 9C0 13.95 4.05 18 9 18C13.95 18 18 13.95 18 9C18 4.05 13.95 0 9 0ZM9 16.2C5.04 16.2 1.8 12.96 1.8 9C1.8 5.04 5.04 1.8 9 1.8C12.96 1.8 16.2 5.04 16.2 9C12.96 16.2 9 16.2Z" fill="currentColor"/>
                  <path d="M9 4.5C8.586 4.5 8.25 4.836 8.25 5.25V8.25H5.25C4.836 8.25 4.5 8.586 4.5 9C4.5 9.414 4.836 9.75 5.25 9.75H8.25V12.75C8.25 13.164 8.586 13.5 9 13.5C9.414 13.5 9.75 13.164 9.75 12.75V9.75H12.75C13.164 9.75 13.5 9.414 13.5 9C13.5 8.586 13.164 8.25 12.75 8.25H9.75V5.25C9.75 4.836 9.414 4.5 9 4.5Z" fill="currentColor"/>
                </svg>
              </button>
            </div>
            {{ form.avatar }}
            <div class="profile-edit-info">
              <div class="profile-edit-name">
                {% if user.first_name or user.last_name %}
                  {{ user.first_name }} {{ user.last_name }}
                {% else %}
                  {{ user.username }}
                {% endif %}
              </div>
              <div class="profile-edit-username">@{{ user.username }}</div>
            </div>
          </div>

          <!-- Nombre y Apellido -->
          <div class="edit-section">
            <div class="edit-section-title">Información de usuario</div>
            <div class="edit-sections-container">
              <div class="edit-section">
                <div class="edit-field">
                  <label class="edit-label">Nombre</label>
                  {{ form.first_name }}
                </div>
                <div class="edit-field">
                  <label class="edit-label">Apellido</label>
                  {{ form.last_name }}
                </div>
              </div>
              <div class="edit-section">
                <div class="edit-field">
                  <label class="edit-label">Correo</label>
                  {{ form.email }}
                </div>
              </div>
            </div>
          </div>

          <div class="edit-section">
            <div class="edit-section-title">Información personal</div>

            <div class="edit-field">
              <label class="edit-label">Biografía</label>
              {{ form.biography }}
              <div class="counter"><span id="bio-counter">0</span> / 130</div>
            </div>
          </div>

          <div class="edit-sections-container">
            <div class="edit-section">
              <div class="edit-field">
                <label class="edit-label">Fecha de Nacimiento</label>
                <div class="date-field-container">
                  {{ form.birth_date }}
                  <span class="date-icon">📅</span>
                </div>
              </div>

              <div class="edit-field">
                <label class="edit-label">Color Favorito</label>
                {{ form.favorite_color }}
              </div>

              <div class="edit-field">
                <label class="edit-label">Videojuegos Favoritos</label>
                {{ form.favorite_games }}
              </div>
            </div>

            <div class="edit-section">
              <div class="edit-field">
                <label class="edit-label">Cédula</label>
                {{ form.national_id }}
              </div>

              <div class="edit-field">
                <label class="edit-label">Libros Favoritos</label>
                {{ form.favorite_books }}
              </div>

              <div class="edit-field">
                <label class="edit-label">Música Favorita</label>
                {{ form.favorite_music }}
              </div>

              <div class="edit-field">
                <label class="edit-label">Lenguajes de Programación</label>
                {{ form.programming_languages }}
              </div>
            </div>
          </div>
          <button type="submit" class="save-btn">Guardar</button>
        </form>
      </div>
    </div>

    <script>
      // Función para cargar un archivo HTML en un elemento
      function loadHTML(selector, filePath) {
        fetch(filePath)
          .then((response) => response.text())
          .then((html) => {
            document.querySelector(selector).innerHTML = html;
          })
          .catch((error) =>
            console.error("Error al cargar el archivo:", error)
          );
      }

      // Cargar el footer cuando el DOM esté listo
      document.addEventListener("DOMContentLoaded", () => {
        loadHTML("#menu-main", "{% url 'funATIAPP:menu_main' %}");
        
        // Character counter for biography
        const bioTextarea = document.getElementById('id_biography');
        const bioCounter = document.getElementById('bio-counter');
        
        if (bioTextarea && bioCounter) {
          function updateCounter() {
            const length = bioTextarea.value.length;
            bioCounter.textContent = length;
            if (length > 130) {
              bioCounter.style.color = 'red';
            } else {
              bioCounter.style.color = '#888';
            }
          }
          
          updateCounter(); // Initial count
          bioTextarea.addEventListener('input', updateCounter);
        }
        
        // Avatar preview
        const avatarInput = document.getElementById('id_avatar');
        const avatarPreview = document.getElementById('avatar-preview');
        
        if (avatarInput && avatarPreview) {
          avatarInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function(e) {
                if (avatarPreview.tagName === 'DIV') {
                  // Replace placeholder with img
                  const img = document.createElement('img');
                  img.src = e.target.result;
                  img.alt = 'Avatar';
                  img.className = 'avatar-img';
                  img.id = 'avatar-preview';
                  avatarPreview.parentNode.replaceChild(img, avatarPreview);
                } else {
                  avatarPreview.src = e.target.result;
                }
              };
              reader.readAsDataURL(file);
            }
          });
        }
      });
    </script>
    
    <style>
      .profile-edit-avatar {
        position: relative;
        display: inline-block;
      }
      
      .avatar-img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
      }
      
      .avatar-placeholder {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: #e1e8ed;
        background-image: url("{% static 'assets/user-placeholder.png' %}");
        background-size: cover;
        background-position: center;
      }
      
      .change-avatar-btn {
        position: absolute;
        bottom: -5px;
        right: -5px;
        background: #e91e63;
        color: white;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      
      .change-avatar-btn:hover {
        background: #c2185b;
        transform: scale(1.05);
      }
      
      .change-avatar-btn svg {
        width: 16px;
        height: 16px;
      }
      
      #id_avatar {
        display: none;
      }
      
      .date-field-container {
        position: relative;
      }
      
      .date-input {
        padding-right: 40px;
      }
    </style>
    
    <!-- JavaScript del tema -->
    <script src="{% static 'js/theme.js' %}"></script>
  </body>
</html>
